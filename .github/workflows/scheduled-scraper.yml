name: Scraper with Supabase Sync

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:

jobs:
  scrape-and-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run scraper with Supabase sync + contacts
        timeout-minutes: 25
        env:
          PYTHONPATH: src
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          FETCH_TIMEOUT: ${{ vars.FETCH_TIMEOUT || '20' }}
          ENRICH_TIMEOUT: ${{ vars.ENRICH_TIMEOUT || '30' }}
          FETCH_MAX_RETRIES: ${{ vars.FETCH_MAX_RETRIES || '10' }}
          ENRICH_MAX_RETRIES: ${{ vars.ENRICH_MAX_RETRIES || '5' }}
          FETCH_RETRY_WAIT: ${{ vars.FETCH_RETRY_WAIT || '5.0' }}
          ENRICH_RETRY_WAIT: ${{ vars.ENRICH_RETRY_WAIT || '60.0' }}
          USE_PROXY: ${{ vars.USE_PROXY || 'false' }}
          PROXY_URL: ${{ vars.PROXY_URL || '' }}
          CONTACTS_WORKERS: ${{ vars.CONTACTS_WORKERS || '100' }}
          CONTACTS_BATCH_SIZE: ${{ vars.CONTACTS_BATCH_SIZE || '20' }}
          CONTACTS_DAYS_FILTER: ${{ vars.CONTACTS_DAYS_FILTER || '120' }}
        run: |
          CMD="python -m kickstarter_tools.run"
          CMD="$CMD --fetch-timeout $FETCH_TIMEOUT"
          CMD="$CMD --enrich-timeout $ENRICH_TIMEOUT"
          CMD="$CMD --fetch-max-retries $FETCH_MAX_RETRIES"
          CMD="$CMD --enrich-max-retries $ENRICH_MAX_RETRIES"
          CMD="$CMD --fetch-retry-wait $FETCH_RETRY_WAIT"
          CMD="$CMD --enrich-retry-wait $ENRICH_RETRY_WAIT"
          CMD="$CMD --contacts-workers $CONTACTS_WORKERS"
          CMD="$CMD --contacts-batch-size $CONTACTS_BATCH_SIZE"
          CMD="$CMD --days-filter $CONTACTS_DAYS_FILTER"
          
          if [ "$USE_PROXY" = "true" ]; then
            CMD="$CMD --use-proxy"
          else
            CMD="$CMD --disable-proxy"
          fi
          
          echo "ðŸš€ Running pipeline: $CMD"
          eval $CMD
          echo "âœ… Kickstarter fetch, Supabase sync, and Firecrawl contacts completed"
